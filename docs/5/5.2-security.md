# Security

## SSH keys
overview:
SSH keys are created in pairs as a public and a private key. SSH keys allow you to securely access remote hosts as well as serve as authentication for many services, including github. As a rule of thumb you can add your public key to many remote hosts, as well as to many different services, but you cannot share your private key. Sharing your private key would be like giving out your password. Don't do it. 

## Lastpass
Lastpass is one of many password managers available that allow you to have a strong and unique password on every website/service you use. As an employee at Liatrio you may have to create many accounts across different services, and using the same insecure password for all of them can lead to vulnerability. If one of your passwords is cracked/leaked/discovered, and you use the same credentials on a different service, it can become insecure as well. You don't want to be responsible for an internal tool being exploited for bitcoin mining, so make sure your passwords are secure.

## KeePass
Shared credentials, like ec2 .pem keys (private keys) are located in keepass. Keepass is an open source password manager that can be downloaded with brew:
brew cask install keepassx

## SELinux
Security Enhanced Linux is a kernel module that provides kernel modifications to enforce access control policies. SELinux limits the privilege of user's programs to the minimum that are required to work. This limits the ability of insecure programs to cause damage to the rest of the system. In this "confined" environment created by SELinux, there is no "super-user" with root privileges, which is one of the most common ways a program on linux is exploited.

## Purging from Github
If you accidentally push some private data into git (password/etc) it needs to be removed immediately. This is important even for private repos, as we may add contributors or make the repo public. Github is not a safe place to store your passwords and ssh keys. Git will keep record of your change, however, and you will need to rebase to rewrite the history and remove the password. If you are uncomfortable with rebases check out the 5.5 Commit Reversals guide, or ask someone to help you out. It is important that we are secure, but we don't want to destroy git history unless its absolutely necessary.

## Firewalls and Security Groups
Firewalls are network security systems that monitor/filter network traffic. Previously we would often have to open ports to traffic by configuring the firewall on a given instance. Because many of our instances are on Amazon Ec2, we use the Ec2 security groups to create rules that can be applied and re-used on many different services. The security groups have rules that act as virtual firewalls for one or more instances, and will prevent traffic over a given set of ports, or even a certain protocol. Security groups can even use client ip to filter traffic.

<center>
  ![](../img/build.png)  
</center>

## Activity

After correctly setting security groups to an AWS instance, you connect to it using ssh. Knowing what ssh keys are, and how to use them correctly is an integral part of being an effective DevOps engineer, as they are the primary way to access Linux servers as well as authenticate for many toolsets.

## Overview
SSH keys are public/private key pairs that make up a cryptographically secure authentication method used for many applications. One of the primary uses of public/private keys is ssh authentication. When using a key pair it is vital to keep your private key secure. You can, however, put your public key on multiple servers. A public key alone cannot give a user access to any confidential data, however a public key can be generated using a private key. This is because the RSA algorithm (the most common public-private key algorithm) stores all the public key fields in the private key. Because of this, be wary of where the private key is stored, and how secure it is.

## Creating an RSA Pair

To create a public/private keypair in the ~/.ssh directory (where keys are most often stored):

ssh-keygen -t rsa -b 4096 -C "<your_email_here>@liatrio.com"


This will  create a new key pair with your email address as the label (important so you don't get the keys mixed up). You ill then be prompted to name a file in which to store the keypair. The default location is 

"/Users/<your name>/.ssh/id_rsa". To change the name simply type /Users/<your name>/.ssh/<key name> and hit enter.

At the next prompt, it will ask you for a passphrase. You can leave this empty or fill it in as you see fit. If you enter a password you will need to type this in any time you use this key, so don't forget it.

Confirm your passphrase then hit enter to continue.

You have now created a key pair! It is located in two files in the specified folder (~/.ssh) One is a public key (<key name>.pub) and the other is the private key <private>

## Uploading a Key Pair to AWS
When creating an AWS EC2 instance you have the option to select a key pair to place into the instance when it is created. This is how you initially gain ssh access to the instance. To create an instance with your own key pair, you must first upload it to AWS. From the AWS console, navigate to EC2 > Network & Security > Key Pairs, select "Import Key Pair", and upload your public key. Your key pair will now appear in the drop down menu when creating new EC2 instances.

Key pairs are created per-region, so a key pair created in us-west-2 will not be available to use when creating instances in us-west-1 or us-east-2.

When creating an EC2 instance, the selected public key will be placed in the authorized_keys file of the default Linux user from whatever machine image (AMI) the instance was created with. On Amazon Linux this is ec2-user, on CentOS 7 it is centos.


## Connecting to an Instance
To connect to an instance containing your public key, you much ssh into it using your private key. For EC2 instances if you aren't sure what user to login as, go to the EC2 console, right-click your instance, and select "connect." 

ssh -i /path/to/private-key user@host
If you generated your key pair using the default names (id_rsa/id_rsa.pub), most ssh implementation on *nix systems will use it by default, saving a few keystrokes. With all the time saved you could pick up a new hobby, like birdwatching.

## Connecting With a Different Key Pair
Suppose you want to give a coworker access to your instance, or give yourself access from another computer with a different key pair. To do this, you must append a public key to the authorized_keys file of the user you want to connect as. 

cat /path/to/public-key | ssh user@host "tee -a ~/.ssh/authorized_keys"
Careful! Don't overwrite the authorized_keys file, just append to it. Overwriting the authorized_keys file will remove any public keys that were already in there, potentially locking you out of your own instance.

The asymmetric (public/private) key pair is only used for the initial authentication phase of an ssh connection. Afterwords a symmetric key is used to encrypt traffic between the hosts. Check out this article for more details about how ssh cryptography works.

## Liatrio's SSH Authorization Strategy
Our strategy for managing ssh access revolves around avoiding "master keys" whenever possible. Instead, each employee should have their own key pair that they never reveal to anyone (not even their mom!). This helps make our infrastructure more secure and avoids issues when off-boarding employees. Here are the key points to our strategy:

Create a personal RSA key pair (as you did the previous steps) that you never share with anyone.
Import the key pair to AWS. Give it the same name as your liatrio.com email username.
Instances created with your key pair are owned by you. You are responsible for managing its accessibility and terminating it when it is no longer needed.
Grant access to your instances by appending public keys to authorized_keys files.
To make it easier to share public keys, we maintain an S3 bucket with all of our public keys. Files in this bucket contain one or more public keys that you can easily append to your authorized keys files.

To grant a group/individual access to an instance, you can do something like:

curl https://s3-us-west-2.amazonaws.com/liatrio-authorized-keys-groups/<group-name> >>~/.ssh/authorized_keys

other section

# Deliverable

Connect to the instances above and provided documentation for how you did it
